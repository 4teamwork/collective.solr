<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en"
      xmlns:tal="http://xml.zope.org/namespaces/tal"
      xmlns:metal="http://xml.zope.org/namespaces/metal"
      xmlns:i18n="http://xml.zope.org/namespaces/i18n"
      lang="en"
      metal:use-macro="here/main_template/macros/master"
      i18n:domain="plone">
<body>
<div metal:fill-slot="main"
         tal:define="results view/results">
  <script src="https://ajax.googleapis.com/ajax/libs/angularjs/1.3.0-beta.1/angular.min.js"></script>
  <script type="text/javascript">
var myModule = angular.module('myApp', []);

myModule.factory('searchService',
  function($http) {
    'use strict';

    var runUserRequest = function(searchTerm, portalType) {
      return $http({
        method: 'GET',
        url: portal_url + '/json-search-results',
        params: {
          'facet': 'true',
          'fq': 'portal_type:' + portalType,
          'facet.field': 'portal_type',
          'SearchableText': searchTerm
        }
      });
    };
    return {
      searchResults: function(searchTerm, portalType) {
        return runUserRequest(searchTerm, portalType);
      }
    };
  }
);

myModule.controller('SearchController',
  function($scope, $timeout, searchService) {
    'use strict';
    var timeout;
    $scope.search = {
      facet: {
        portal_type: 'Document'
      },
    };

    function updateSearchResults() {
      var newSearchTerm = $scope.search.term;
      var newPortalType = $scope.search.facet.portal_type;
      if (newSearchTerm) {
        if (timeout) $timeout.cancel(timeout);
        timeout = $timeout(function() {
          searchService.searchResults(newSearchTerm, newPortalType)
          .success(function(data, status) {
            $scope.search.results = data;
          });
        }, 350);
      }
    };

    $scope.changeFacet = function(portalType) {
      $scope.search.facet.portal_type = portalType;
      updateSearchResults();
    };

    $scope.$watch('search.term', function() {
      updateSearchResults();
    });
  }
);

  </script>
  <div ng-app="myApp">
    <div ng-controller="SearchController">
      <input type="text" ng-model="search.term" placeholder="Enter search"/>
      <h3>Facets</h3>
      <h5>Content Type</h5>
      <ul>
        <li>
          <a ng-click="changeFacet('Folder')">
            Folder
          </a>
        </li>
        <li>
          <a ng-click="changeFacet('Document')">
            Document
          </a>
        </li>
      </ul>
      <h3>Results</h3>
      <ul>
        <li ng-repeat="item in search.results">
          <a ng-href="{{item.url}}">
            {{ item.title }} ( {{item.portal_type}} )
          </a>
        </li>
      </ul>
    </div>
  </div>

<!--
  <h2>Search Term</h2>
  <div tal:content="request/SearchableText|nothing" />

  <h2>Results</h2>
  <ul tal:repeat="item results">
    <li>
      <a href=""
         tal:attributes="href item/getPath;"
         tal:content="item/Title"></a>
    </li>
  </ul>
-->
  <div tal:define="view nocall: context/@@search-facets | nothing"
       tal:condition="python: view"
       tal:replace="structure python: view(results=results)" />

  <div tal:define="view nocall: context/@@search-facets | nothing"
       tal:condition="python: view"
       tal:replace="structure view/hiddenfields" />

</div>
</body>
</html>
