<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en"
      xmlns:tal="http://xml.zope.org/namespaces/tal"
      xmlns:metal="http://xml.zope.org/namespaces/metal"
      xmlns:i18n="http://xml.zope.org/namespaces/i18n"
      lang="en"
      metal:use-macro="here/main_template/macros/master"
      i18n:domain="plone">
<body>
<div metal:fill-slot="main"
         tal:define="results view/results">
  <script src="https://ajax.googleapis.com/ajax/libs/angularjs/1.3.0-beta.1/angular.min.js"></script>
  <script type="text/javascript">
var myModule = angular.module('myApp', []);

myModule.factory('searchService',
  function($http) {
    'use strict';

    var runUserRequest = function(searchTerm, portalType, batchStart) {
      return $http({
        method: 'GET',
        url: portal_url + '/json-search-results',
        params: {
          'facet': 'true',
          'fq': 'portal_type:' + portalType,
          'facet.field': 'portal_type',
          'b_start': batchStart,
          'SearchableText': searchTerm
        }
      });
    };
    return {
      searchResults: function(searchTerm, portalType, batchStart) {
        return runUserRequest(searchTerm, portalType, batchStart);
      }
    };
  }
);

myModule.controller('SearchController',
  function($scope, $timeout, searchService) {
    'use strict';
    var timeout;
    $scope.search = {
      facet: {
        portal_type: 'Document'
      },
      facets: {
        'Folder': 0,
        'Document': 0,
        'News Item': 0,
        'Event': 0,
        'Collection': 0,
      },
      batchStart: 0,
    };

    function updateSearchResults() {
      var newSearchTerm = $scope.search.term;
      var newPortalType = $scope.search.facet.portal_type;
      var batchStart = $scope.search.batchStart;
      if (newSearchTerm) {
        if (timeout) $timeout.cancel(timeout);
        timeout = $timeout(function() {
          searchService.searchResults(newSearchTerm, newPortalType, batchStart)
          .success(function(data, status) {
            $scope.search.results = data.results;
            $scope.search.facets = data.facets;
          });
        }, 350);
      }
    };

    $scope.batchNext = function() {
      $scope.search.batchStart = $scope.search.batchStart + 10;
      updateSearchResults();
    };
    $scope.batchPrevious = function() {
      $scope.search.batchStart = $scope.search.batchStart - 10;
      updateSearchResults();
    };
    $scope.changeFacet = function(portalType) {
      $scope.search.facet.portal_type = portalType;
      updateSearchResults();
    };

    $scope.$watch('search.term', function() {
      updateSearchResults();
    });
  }
);

  </script>
  <div ng-app="myApp">
    <div ng-controller="SearchController">
      <input type="text" ng-model="search.term" placeholder="Enter search" />
      <h3>Facets</h3>
      <h5>Content Type</h5>
      <ul>
        <li ng-repeat="(key, value) in search.facets">
          <a ng-click="changeFacet(key)">
            {{key}}: {{value}}
          </a>
        </li>
      </ul>
      <h3>Results</h3>
      <ul>
        <li ng-repeat="item in search.results">
          <a ng-href="{{item.url}}">
            {{ item.title }} ( {{item.portal_type}} )
          </a>
        </li>
      </ul>
      <a ng-click="batchPrevious()">Previous</a>
      <a ng-click="batchNext()">Next</a>
    </div>
  </div>

</div>
</body>
</html>
