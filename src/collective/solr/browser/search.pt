<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en"
      xmlns:tal="http://xml.zope.org/namespaces/tal"
      xmlns:metal="http://xml.zope.org/namespaces/metal"
      xmlns:i18n="http://xml.zope.org/namespaces/i18n"
      lang="en"
      metal:use-macro="here/main_template/macros/master"
      i18n:domain="plone">
<body>
<div metal:fill-slot="main"
         tal:define="results view/results">
  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.2.0/css/bootstrap.min.css">
  <script src="https://ajax.googleapis.com/ajax/libs/angularjs/1.3.0-beta.1/angular.min.js"></script>
  <script src="https://angular-ui.github.io/bootstrap/ui-bootstrap-tpls-0.11.0.js"></script>
  <script type="text/javascript">
var myModule = angular.module('myApp', ['ui.bootstrap']);

myModule.factory('searchService',
  function($http) {
    'use strict';

    var runUserRequest = function(searchTerm, portalType, batchStart, batchSize) {
      return $http({
        method: 'GET',
        url: portal_url + '/json-search-results',
        params: {
          'facet': 'true',
          'fq': 'portal_type:' + portalType,
          'facet.field': 'portal_type',
          'b_start': batchStart,
          'b_size': batchSize,
          'SearchableText': searchTerm
        }
      });
    };
    return {
      searchResults: function(searchTerm, portalType, batchStart, batchSize) {
        return runUserRequest(searchTerm, portalType, batchStart, batchSize);
      }
    };
  }
);

myModule.controller('SearchController',
  function($scope, $timeout, searchService) {
    'use strict';
    var timeout;
    $scope.search = {
      facet: {
        portal_type: 'Document'
      },
      facets: {
        'Folder': 0,
        'Document': 0,
        'News Item': 0,
        'Event': 0,
        'Collection': 0,
      },
      batching: {
        batchStart: 1,
        batchSize: 10,
        currentPage: 1,
        totalItems: 0,
      },
      results: [],
    };

    function updateSearchResults() {
      var newSearchTerm = $scope.search.term;
      var newPortalType = $scope.search.facet.portal_type;
      var batchStart = $scope.search.batching.batchStart;
      var batchSize = $scope.search.batching.batchSize;
      if (newSearchTerm) {
        if (timeout) $timeout.cancel(timeout);
        timeout = $timeout(function() {
          batchStart = $scope.search.batching.batchStart = ((($scope.search.batching.currentPage - 1) * $scope.search.batching.batchSize) + 1);
          searchService.searchResults(newSearchTerm, newPortalType, batchStart, batchSize)
          .success(function(data, status) {
            $scope.search.results = data.results;
            $scope.search.facets = data.facets;
            $scope.search.batching.totalItems = data.totalItems;
          });
        }, 350);
      }
    };

    $scope.$watch('search.batching.currentPage', function(newCurrentPage) {
      if (newCurrentPage) {
        $scope.search.batching.currentPage = newCurrentPage;
        updateSearchResults();
      }
    });

    $scope.batchNext = function() {
      $scope.search.batching.batchStart = $scope.search.batching.batchStart + 10;
      updateSearchResults();
    };
    $scope.batchPrevious = function() {
      $scope.search.batching.batchStart = $scope.search.batching.batchStart - 10;
      updateSearchResults();
    };
    $scope.changeFacet = function(portalType) {
      $scope.search.facet.portal_type = portalType;
      updateSearchResults();
    };

    $scope.$watch('search.term', function() {
      updateSearchResults();
    });
  }
);

  </script>
  <div ng-app="myApp">
    <div ng-controller="SearchController">
      <input type="text" ng-model="search.term" placeholder="Enter search" />
      <h3>Facets</h3>
      <h5>Content Type</h5>
      <ul>
        <li ng-repeat="(key, value) in search.facets">
          <a ng-click="changeFacet(key)">
            {{key}}: {{value}}
          </a>
        </li>
      </ul>
      <h3>Results</h3>
      <h4>Pagination</h4>
      TotalItems: {{search.batching.totalItems}}<br />
      BatchStart: {{search.batching.batchStart}}<br />
      BatchSize: {{search.batching.batchSize}}" /><br />
      CurrentPage: {{search.batching.currentPage}}<br />
      <pagination boundary-links="true" total-items="search.batching.totalItems" ng-model="search.batching.currentPage" class="pagination-sm" previous-text="&lsaquo;" next-text="&rsaquo;" first-text="&laquo;" last-text="&raquo;"></pagination>
      <ul>
        <li ng-repeat="item in search.results">
          <a ng-href="{{item.url}}">
            {{ item.title }} ( {{item.portal_type}} )
          </a>
        </li>
      </ul>
    </div>
  </div>

</div>
</body>
</html>
